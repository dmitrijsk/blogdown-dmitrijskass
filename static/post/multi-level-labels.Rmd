---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = 'center', fig.height = 3, fig.width = 6)
```

Sometimes x axis labels may be combined into groups in order to show the nested structure of labels or to remove declutter the chart. Example of a nested structure may be shops that belong to regions or departments that belong to one company. Example of decluttering is removing the years part of dates and placing then separately. Many of us have seen such nested structure of x axis labels in MS Excel:

Such labels have different names, e.g. "nested categories", "super categories" and "multi-level labels" in MS Excel. There is no direct way to create them in ggplot2, however, there several work arounds. These work arounds depend on the type of the chart - whether data points belonging to different groups must be connected or not. Let's review how to create multi-level x axis labels exactly in this taxanomy.

## No intra-group connections between data points

This is the chart we will be creating in this section:

```{r echo = FALSE}
library(dplyr)
library(ggplot2)

# Bar chart ----

TIMES <- c(2, 4, 3)
set.seed(4)
data <- tibble(group = c(rep(paste("Group", 1:3), times = TIMES)),
               question = LETTERS[1:sum(TIMES)],
               proportion = runif(sum(TIMES)))

openxlsx::write.xlsx(data, file = "data_cols.xlsx")

data %>% 
  ggplot(aes(x = question, y = proportion)) +
  geom_col() +
  facet_grid(~group, scales = "free_x", switch = "x", space = "free_x") +
  theme(strip.placement = "outside", 
        strip.background = element_rect(fill = "white"), 
        axis.title = element_blank()) +
  labs(title = "Bar chart with multi-level x-axis labels")
```

First, let's simulate the data for this chart. It will look like survey results with `r sum(TIMES)` questions labeled from A to `r LETTERS[sum(TIMES)]` and combined into `r length(TIMES)` groups. These will be x-axis labels. The y-axis values are drawn from a uniform distribution. Let them be proportions of respondents that correctly answered corresponding questions.

```{r}
# `tibble` and `%>%`.
library(dplyr)

# For reproducibility.
set.seed(4) 

# Counts of elements in each of three group.
TIMES <- c(2, 4, 3)

# Simulate data.
data <- tibble(group = c(rep(paste("Group", 1:3), times = TIMES)),
               question = LETTERS[1:sum(TIMES)],
               proportion = runif(sum(TIMES)))

data
```

There are several popular methods for multi-level labels found on Stack Overflow.

```{r}
# Super-categories for x-axis (in the end came up with a simple solution with labels).
# https://stackoverflow.com/questions/48552671/ggplot2-show-category-and-sub-category-for-x-axis-labels
# https://stackoverflow.com/questions/44247239/grouping-on-the-x-axis-in-ggplot2
# https://stackoverflow.com/questions/20571306/multi-row-x-axis-labels-in-ggplot-line-chart
# https://stackoverflow.com/questions/44616530/axis-labels-on-two-lines-with-nested-x-variables-year-below-months/44616739
# https://github.com/tidyverse/ggplot2/issues/1966
```

The faceting approach starts with a simple bar chart (chart A) that is turned into [small multiples](https://en.wikipedia.org/wiki/Small_multiple) bar chart with `facet_grid()` (chart B). The next step is to let the x-axis vary across facets with the argument `scales = "free_x"`, move the facet labels to the bottom with the argument `switch = "x"` and let the width of facets vary with the argument `space = "free_x"`. The last argument makes bars have the width.

```{r fig.width=15}
p_a <- data %>% 
  ggplot(aes(x = question, y = proportion)) +
  geom_col() +
  labs(tag = "A")

p_b <- p_a +
  facet_grid(~group) +
  labs(tag = "B")

p_c <- p_b +
  facet_grid(~group, scales = "free_x", switch = "x", space = "free_x") +
  labs(tag = "C")

gridExtra::grid.arrange(p_a, p_b, p_c, nrow = 1)
```




## Intra-group connections between data points


